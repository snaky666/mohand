# دليل إعداد Supabase لموقع ⵎⵓⵃⵎⵎⴷ Barber

## الخطوات المطلوبة

### 1. إنشاء الجداول في Supabase

1. افتح لوحة تحكم Supabase الخاصة بك: https://supabase.com/dashboard
2. اختر مشروعك
3. اذهب إلى **SQL Editor** من القائمة الجانبية
4. انسخ **كامل محتوى** ملف `supabase-setup.sql`
5. الصق في المحرر
6. اضغط **Run** أو **F5** لتنفيذ الأوامر

### 2. التحقق من إنشاء الجداول

بعد تنفيذ الأوامر SQL:

1. اذهب إلى **Table Editor** في لوحة تحكم Supabase
2. تأكد من وجود الجداول التالية:
   - ✅ `bookings` - جدول الحجوزات
   - ✅ `announcements` - جدول الإعلانات

### 3. تغيير كلمة مرور الإدارة (مهم جداً!)

⚠️ **ضروري للأمان**: يجب تغيير كلمة المرور الافتراضية!

كلمة المرور الافتراضية: `admin123`

**لتغيير كلمة المرور:**

1. افتح ملف `server.py`
2. ابحث عن السطر:
   ```python
   if password != 'admin123':
   ```
3. غيّر `'admin123'` إلى كلمة مرور قوية جديدة (مثال: `'MySecureP@ss2025'`)
4. احفظ الملف
5. أعد تشغيل الخادم

**نصائح لكلمة مرور قوية:**
- لا تقل عن 12 حرف
- اخلط بين أحرف كبيرة وصغيرة وأرقام ورموز
- لا تستخدم كلمات شائعة
- لا تشارك كلمة المرور مع أحد

### 4. التحقق من السياسات الأمنية (Row Level Security)

الإعدادات الأمنية الحالية:

#### جدول bookings:
- ✅ قراءة: مسموح للجميع (للعرض)
- ✅ إضافة: مسموح للجميع (للحجز)
- ❌ حذف: ممنوع من المتصفح (يتم عبر الخادم فقط)

#### جدول announcements:
- ✅ قراءة: مسموح للجميع (للعرض)
- ❌ إضافة/تعديل: ممنوع من المتصفح (يتم عبر الخادم فقط)

**ملاحظة أمنية**: تم تصميم النظام بحيث أن:
1. العملاء يمكنهم القراءة والحجز فقط
2. العمليات الحساسة (حذف، تعديل) تتطلب كلمة مرور الإدارة
3. كلمة المرور يتم التحقق منها على الخادم فقط
4. `SUPABASE_SERVICE_ROLE_KEY` يُستخدم على الخادم فقط ولا يظهر للمتصفح

### 5. اختبار الموقع

بعد إعداد قاعدة البيانات وتغيير كلمة المرور:

#### الصفحة الرئيسية (للعملاء):
1. افتح الصفحة الرئيسية للموقع
2. جرب إنشاء حجز جديد
3. املأ البيانات (الاسم، التاريخ، رقم الهاتف)
4. اضغط "احجز الآن"
5. تحقق من ظهور رسالة النجاح
6. تحقق من ظهور الحجز في قائمة "الحجوزات القادمة"

#### لوحة الإدارة:
1. افتح صفحة `/admin.html`
2. أدخل كلمة المرور الجديدة التي قمت بإنشائها
3. تحقق من:
   - ✅ ظهور الإحصائيات (إجمالي الحجوزات، الدخل، إلخ)
   - ✅ قائمة جميع الحجوزات
   - ✅ إمكانية حذف الحجوزات
   - ✅ إمكانية إضافة/تعديل الإعلانات

#### صفحة العروض:
1. افتح صفحة `/ads.html`
2. تحقق من عرض الخدمات والأسعار
3. تحقق من ظهور الإعلان (إذا تم إضافته من لوحة الإدارة)

## هيكل قاعدة البيانات

### جدول bookings
```sql
id          UUID (مفتاح أساسي)
name        TEXT (اسم العميل)
phone       TEXT (رقم الهاتف)
day         DATE (تاريخ الحجز)
created_at  TIMESTAMP (تاريخ الإنشاء)
updated_at  TIMESTAMP (تاريخ التحديث)
```

### جدول announcements
```sql
id          UUID (مفتاح أساسي)
message     TEXT (نص الإعلان)
created_at  TIMESTAMP (تاريخ الإنشاء)
updated_at  TIMESTAMP (تاريخ التحديث)
```

## الأمان

### الحماية المطبقة:
1. **Row Level Security (RLS)**: مُفعَّل على جميع الجداول
2. **سياسات قراءة محدودة**: العملاء يمكنهم القراءة والإضافة فقط
3. **عمليات إدارية آمنة**: الحذف والتعديل عبر الخادم فقط
4. **مصادقة كلمة المرور**: لوحة الإدارة تطلب كلمة مرور في كل عملية
5. **استخدام Service Role Key**: للعمليات الحساسة فقط على الخادم
6. **عدم تخزين كلمة المرور**: كلمة المرور تُرسل مع كل طلب ولا تُخزن في المتصفح

### نقاط الأمان الرئيسية:
- ❌ لا يمكن لأي زائر حذف حجوزات من المتصفح
- ❌ لا يمكن لأي زائر تعديل الإعلانات من المتصفح
- ✅ جميع العمليات الإدارية تمر عبر الخادم مع التحقق من كلمة المرور
- ✅ مفتاح Service Role محمي في متغيرات البيئة ولا يظهر للمتصفح
- ✅ كلمة المرور تُطلب من المستخدم ولا تُحفظ في الكود

### ⚠️ تحذير أمني مهم:
**يجب تغيير كلمة المرور الافتراضية `admin123` فوراً!**

إذا لم تغيّر كلمة المرور، فإن أي شخص يعرف كلمة المرور الافتراضية يمكنه الوصول إلى لوحة الإدارة.

## استكشاف الأخطاء

### خطأ: "Could not find the table"
**السبب**: الجداول غير موجودة في قاعدة البيانات.

**الحل**:
1. افتح Supabase SQL Editor
2. انسخ محتوى `supabase-setup.sql`
3. شغّل الأوامر SQL
4. حدّث صفحة الموقع

### خطأ: "Unauthorized" عند الحذف أو التعديل
**السبب**: كلمة مرور خاطئة.

**الحل**:
1. تأكد من إدخال كلمة المرور الصحيحة
2. تحقق من أنك غيّرت كلمة المرور في `server.py`
3. أعد تشغيل الخادم بعد تغيير كلمة المرور

### خطأ في الاتصال
**السبب**: مفاتيح API خاطئة أو مشروع متوقف.

**الحل**:
1. تحقق من صحة `SUPABASE_URL` في Secrets
2. تحقق من صحة `SUPABASE_ANON_KEY` في Secrets
3. تحقق من صحة `SUPABASE_SERVICE_ROLE_KEY` في Secrets
4. تأكد من أن المشروع في Supabase نشط

### الحجوزات لا تظهر
**السبب**: RLS Policies غير مطبقة بشكل صحيح.

**الحل**:
1. راجع `supabase-setup.sql`
2. تأكد من تطبيق جميع السياسات
3. تحقق من Browser Console للأخطاء

## ملاحظات مهمة

- ✅ يتم حذف الحجوزات القديمة تلقائياً (أقدم من اليوم الحالي)
- ✅ النظام يستخدم التوقيت المحلي للخادم
- ✅ سعة الحجز قابلة للتخصيص حسب اليوم
- ✅ الإعلان الافتراضي يُضاف تلقائياً عند الإعداد
- ⚠️ لا تشارك `SUPABASE_SERVICE_ROLE_KEY` أبداً - له صلاحيات كاملة!
- ⚠️ غيّر كلمة مرور الإدارة فوراً للحماية!

## الدعم

إذا واجهت أي مشاكل:

1. **تحقق من Browser Console**:
   - افتح Developer Tools (F12)
   - اذهب إلى Console
   - ابحث عن رسائل الخطأ الحمراء

2. **تحقق من Supabase Logs**:
   - افتح لوحة تحكم Supabase
   - اذهب إلى Logs
   - ابحث عن الأخطاء

3. **تحقق من جميع المفاتيح**:
   - تأكد من وجود 3 مفاتيح في Secrets
   - تأكد من عدم وجود مسافات زائدة

4. **أعد تشغيل الخادم**:
   - في Replit، اضغط Stop
   - ثم اضغط Run

## نصائح للتخصيص

### تغيير كلمة مرور الإدارة (مهم!):
1. افتح `server.py`
2. ابحث عن `if password != 'admin123':`
3. غيّر `'admin123'` إلى كلمة مرور قوية
4. احفظ وأعد تشغيل الخادم

### تغيير سعة الحجز:
1. افتح `assets/js/main.js`
2. ابحث عن دالة `getDailyCapacity(date)`
3. غيّر الأرقام حسب احتياجاتك

### تغيير سعر الحلاقة:
1. افتح `assets/js/admin.js`
2. ابحث عن `const PRICE_PER_BOOKING = 500`
3. غيّر القيمة إلى السعر الجديد

## تفعيل التحديثات الفورية (Realtime)

لكي تظهر الإعلانات والحجوزات فوراً بعد إضافتها دون الحاجة لتحديث الصفحة:

### الخطوة 1: تفعيل Replication في Supabase

1. افتح لوحة تحكم Supabase
2. اذهب إلى **Database** > **Replication**
3. ابحث عن جدول `announcements`
4. فعّل الزر بجانبه (Enable)
5. ابحث عن جدول `bookings`
6. فعّل الزر بجانبه (Enable)

### الخطوة 2: التحقق من التفعيل

بعد تفعيل Realtime:
- ✅ الإعلانات ستظهر فوراً في جميع الصفحات عند إضافتها
- ✅ الحجوزات ستظهر فوراً في الصفحة الرئيسية ولوحة الإدارة
- ✅ لن تحتاج لتحديث الصفحة (F5) لرؤية التغييرات

### ملاحظة
إذا لم تفعّل Realtime، ستحتاج إلى تحديث الصفحة يدوياً (F5) لرؤية الإعلانات والحجوزات الجديدة.
